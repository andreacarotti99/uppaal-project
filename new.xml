<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>/**********************************************************************************************
/******************************* GLOBAL VARIABLES *********************************************
/**********************************************************************************************/
clock general_clock;

chan enter, free_truck, start, wait;
/*
channel declared urgent to inizialize every element of the system in the same moment
*/
urgent broadcast chan initialization;

/*
first element is the distance in km from station 1 to station 2, 
second element is the distance in km from station 2 to station 3
EXPRESSED IN UNITS
*/
const int lineDistance[2] = { 23, 35 };

/*
first element is the max time needed to get from station 1 to 2
second element is the max time needed to get from station 2 to 3
EXPRESSED IN CLOCKS
*/
const int lineMaxDelay[2] = { 20, 30 };

/*
this is a sort of map: it provides information of where are currently the trains,
the train is the INDEX so if for example Train(0) is at station 0, Train(1) is at
station 1, and Train(2) is at station 2 is initialized like this:
int whereIsTrain[3] = {0, 1, 2};
*/
int trainActualStation[3] = { 0, 0, 0 };

/*
same as above, but maps the next station for each train
*/
int trainNextStation[3] = { 1, 1, 1 };

/*
this provides info on whether the station INDEX is free or not : CAN JUST BE CHECKED BY stationAvailableTrucks
*/
//bool stationAvailableToReceiveTrains[3] = {true,true,true}; 

/*
number of available trucks free in the INDEX station
*/
int stationAvailableTrucks[3] = { 0, 2, 2 };

/*
number of total trucks free in the INDEX station
*/
const int stationNumberOfTrucks[3] = { 3, 1, 2 };

/*
charges of train, first element charge of Train(0), second element charge of Train(1) and third element charge of Train(2)
*/
int trainActualCharge[3] = { 100, 5, 100 };

/*
this is the max charge of train INDEX
*/
const int trainMaxCharge[3] = { 100, 100, 100 };


/*
based on the policy that we will decide, this will be accessed by the Train(i) to check whether can go to the next station, and
will be edited by the station that decides who can leave and who cannot
*/
bool trainCanLeaveActualStation[3] = { false, false, false };

/*
velocity of Train(i)
EXPRESSED in UNITS/CLOCK
*/
const int trainVelocity[3] = { 10, 10, 10 };

/*
vector useful to know if a train is going forward or backward: 0-&gt;1-&gt;2
*/
bool trainGoingForward[3] = { true, true, true };

/*
vector used to check if a train is waiting for a station to let it in
*/
bool trainIsWaiting[3] = { false, false, false };

/*
current distance of each train to reach the next station -- Expressed in UNITS
*/
int trainDistanceToNextStation[3] = { 23, 23, 23 };

/*
current time left of each train to reach the next station -- Expressed in CLOCKs
*/
int trainTimeLeft[3] = { 20, 20, 20 };


/*
used to set up communicaitions between trains and stations: indicates the # of trains communicating with a station
*/
int talkingWithStation[3] = { 0, 0, 0 };


bool accessGranted[3] = {false, false, false}; 

/*
t0, t1, t2  t0, t1, t2  t0, t1, t2
----------  ----------  ----------
s0            s1         s2
*/
int trainWantsToAccess[9] = {0,0,0,0,0,0,0,0,0};
int trainCanAccess[9] = {0,0,0,0,0,0,0,0,0};

/**********************************************************************************************
/******************************* GLOBAL FUNCTIONS *********************************************
/**********************************************************************************************/

/*
this function is to initialize everything, right now all the parameters are hard-coded 
*/
void initialize_all(){
}

/*
retrieve info about current max delay -- not used so far
*/
int getCurrentMaxDelay(int TrainNumber) {
    int index;
    if ( trainActualStation[TrainNumber] &lt; trainNextStation[TrainNumber] ) {
        index = trainActualStation[TrainNumber];
    }
    else {
        index = trainNextStation[TrainNumber];
     }
    return lineMaxDelay[index];
}</declaration>
	<template>
		<name>Line</name>
		<parameter>int LineNumber</parameter>
		<declaration>// Line Clocks

// Line Variables
/*
typedef struct{
    int distance[2];    //distance (in km) between each pair of consecutive stations
    int max_delay[2];    //maximum time to reach the following station: associated to each pair of consecutive stations
}line;
*/

// Line Functions 
</declaration>
		<location id="id0" x="-408" y="-459">
			<name x="-433" y="-493">working</name>
		</location>
		<location id="id1" x="-621" y="-459">
			<name x="-637" y="-493">initial</name>
			<committed/>
		</location>
		<init ref="id1"/>
		<transition>
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-569" y="-476">initialization!</label>
			<label kind="assignment" x="-561" y="-450">initialize_all()</label>
			<nail x="-442" y="-459"/>
		</transition>
	</template>
	<template>
		<name>Station</name>
		<parameter>int StationNumber</parameter>
		<declaration>/**********************************************************************************************
/******************************* STATION VARIABLES ********************************************
/**********************************************************************************************/
/*
typedef struct{
    int trucks;
    int availableTrucks;
}station;

station s;
*/

bool letIn = false;


/**********************************************************************************************
/******************************* STATION FUNCTIONS ********************************************
/**********************************************************************************************/
/*
function needed to modify the # of available trucks
*/
void addAvlTrucks(int i) {
   stationAvailableTrucks[StationNumber] += (i);
}

//function to be modified...
void decideWhoCanLeaveActualStation(){
    trainCanLeaveActualStation[2] = true;
}

/*
function to check if a train is waiting for a specific station
---in this way we do not give any priority to the trains ...
*/
void checkTrainArrived(){
    int i;
    for (i=0; i&lt;3; i++){
        if(trainIsWaiting[i])
            if(StationNumber == trainNextStation[i])
                letIn = true;
    }
}

/*
checks whether a train is in the current station or not
*/
bool talkingWithMe() {
    return talkingWithStation[StationNumber] &gt; 0;
}

/*
function to upload the letIn variable
*/
void updateLetIn(bool val){
    letIn = val;
}

//TO BE DELETED: we just need to check if a train is waiting and do not need to know the INDEX (?)

/*
//variable used to check if the station should let a train in
bool letIn[3] = {false, false, false};
//function to check if one or more trains are waiting outside of a specific station
void checkTrainArrived(){
    int i;
    for (i=0; i&lt;3; i++){
        if(trainIsWaiting[i])
            if(StationNumber == trainNextStation[i])
                letIn[i] = true;
    }
}
*/





</declaration>
		<location id="id2" x="-1309" y="-612">
			<name x="-1470" y="-620">waiting_for_trains</name>
		</location>
		<location id="id3" x="-833" y="-399">
			<name x="-816" y="-382">fully_occupied</name>
		</location>
		<location id="id4" x="-833" y="-612">
			<name x="-843" y="-646">idle</name>
		</location>
		<init ref="id4"/>
		<transition>
			<source ref="id2"/>
			<target ref="id2"/>
			<label kind="assignment" x="-1640" y="-620">checkTrainArrived()</label>
			<nail x="-1496" y="-561"/>
			<nail x="-1496" y="-663"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id3"/>
			<nail x="-833" y="-297"/>
			<nail x="-680" y="-297"/>
			<nail x="-680" y="-399"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id3"/>
			<label kind="guard" x="-824" y="-527">stationAvailableTrucks[StationNumber] == 0</label>
			<label kind="synchronisation" x="-824" y="-544">initialization?</label>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id2"/>
			<label kind="guard" x="-1224" y="-646">stationAvailableTrucks[StationNumber] &gt; 0</label>
			<label kind="synchronisation" x="-1011" y="-663">initialization?</label>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id2"/>
			<label kind="guard" x="-1496" y="-799">stationAvailableTrucks[StationNumber] &gt; 1
and letIn</label>
			<label kind="assignment" x="-1496" y="-748">addAvlTrucks(-1), updateLetIn(false)</label>
			<nail x="-1309" y="-723"/>
			<nail x="-1496" y="-722"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id2"/>
			<label kind="guard" x="-1479" y="-442">talkingWithMe()</label>
			<label kind="synchronisation" x="-1479" y="-476">free_truck?</label>
			<label kind="assignment" x="-1479" y="-459">addAvlTrucks(1)</label>
			<nail x="-1309" y="-485"/>
			<nail x="-1487" y="-484"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id2"/>
			<label kind="guard" x="-1071" y="-527">talkingWithMe()</label>
			<label kind="synchronisation" x="-1071" y="-544">free_truck?</label>
			<label kind="assignment" x="-1071" y="-561">addAvlTrucks(1)</label>
			<nail x="-1071" y="-510"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id3"/>
			<label kind="guard" x="-1232" y="-365">stationAvailableTrucks[StationNumber] ==1 and letIn</label>
			<label kind="assignment" x="-1173" y="-382">addAvlTrucks(-1), updateLetIn(false)</label>
			<nail x="-1309" y="-399"/>
		</transition>
	</template>
	<template>
		<name>StationManager</name>
		<declaration>
int canEnter = 0;

void checkIfTrainCanEnter(){
    int i;
    int stationIndex; 
    for (i=0; i&lt;9; i++){
        if(trainWantsToAccess[i]) {
            if(i&gt;=0 and i&lt;3) {
                stationIndex = 0;
                if(stationAvailableTrucks[stationIndex] &gt; 0){
                    trainCanAccess[stationIndex * 3 + i] = 1;
                    stationAvailableTrucks[stationIndex] -= 1;
                    canEnter += 1;
                }
            }
            else { 
                if (i&gt;=3 and i&lt;6) {
                    stationIndex = 1;
                    if(stationAvailableTrucks[stationIndex] &gt; 0){
                        trainCanAccess[stationIndex * 3 + (i-3)] = 1;
                        stationAvailableTrucks[stationIndex] -= 1;
                        canEnter += 1;
                    }
                }
                else {
                    stationIndex = 2;
                    if(stationAvailableTrucks[stationIndex] &gt; 0){
                        trainCanAccess[stationIndex * 3 + (i-6)] = 1;
                        stationAvailableTrucks[stationIndex] -= 1;
                        canEnter += 1;
                    }
                 }
            }
        }
    }
}


</declaration>
		<location id="id5" x="-204" y="-127">
			<name x="-179" y="-152">working</name>
		</location>
		<location id="id6" x="-204" y="-339">
			<committed/>
		</location>
		<location id="id7" x="-450" y="-42">
		</location>
		<init ref="id7"/>
		<transition>
			<source ref="id7"/>
			<target ref="id5"/>
			<label kind="synchronisation" x="-432" y="-101">initialization?</label>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id5"/>
			<label kind="assignment" x="-408" y="-212">canEnter-=1</label>
			<nail x="-289" y="-339"/>
			<nail x="-289" y="-127"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id6"/>
			<label kind="guard" x="-196" y="-220">canEnter</label>
			<label kind="synchronisation" x="-186" y="-237">enter!</label>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id5"/>
			<label kind="guard" x="25" y="-76">canEnter==0</label>
			<label kind="assignment" x="25" y="-93">checkIfTrainCanEnter()</label>
			<nail x="-204" y="-34"/>
			<nail x="17" y="-33"/>
			<nail x="17" y="-127"/>
		</transition>
	</template>
	<template>
		<name>Train</name>
		<parameter>int TrainNumber</parameter>
		<declaration>// Train Clocks
clock trainClock; 
clock timeTraveling; //must be reset as soon as a train enters a station

/**********************************************************************************************
/******************************** TRAIN FUNCTIONS *********************************************
/**********************************************************************************************/

/*
function to raise the battery level of a train -- policy needed
*/
void recharge(){
    if( (trainActualCharge[TrainNumber] + 1)  &lt; trainMaxCharge[TrainNumber] )
        trainActualCharge[TrainNumber] += 1;
}
/*
function to update the charge of a train -- policy needed
*/
void loose_charge(){
    if( (trainActualCharge[TrainNumber] - 1) &gt;= 0 )
        trainActualCharge[TrainNumber] -= 1;
}

/*
function to update the distance to the next station -- policy needed
*/
void update_distance (){
    if ( (trainDistanceToNextStation[TrainNumber] - trainVelocity[TrainNumber]) &gt; 0 )
        trainDistanceToNextStation[TrainNumber] -= trainVelocity[TrainNumber];
    else
        trainDistanceToNextStation[TrainNumber] = 0;
}

/*
function used to update the next station of each train
*/
void updateNextStation(int trainId) {
    if( trainGoingForward[trainId] ) {
        if(trainActualStation[trainId] &lt; 2 )
            trainNextStation[trainId] += 1;
        else{
            trainGoingForward[trainId] = false; //end of line reached! change direction
            trainNextStation[trainId] -= 1;
        }
    }
    else{
        if(trainActualStation[trainId] &gt; 0)
            trainNextStation[trainId] -= 1;
        else {
            trainGoingForward[trainId] = true;    //first station of line reached! change direction
            trainNextStation[trainId] += 1;
        }
    }
}

/*
update the maximum time a train can take to get to the following station
*/
void updateNextTime(int TrainNumber) {
    int index;
    if ( trainActualStation[TrainNumber] &lt; trainNextStation[TrainNumber] ) {
        index = trainActualStation[TrainNumber];
    }
    else {
        index = trainNextStation[TrainNumber];
    }
    trainTimeLeft[TrainNumber] = lineMaxDelay[index];
}

/*
update the distance to reach the following station
*/
void updateNextDistance(int TrainNumber) {
    int index;
    if ( trainActualStation[TrainNumber] &lt; trainNextStation[TrainNumber] )
        index = trainActualStation[TrainNumber];
    else 
        index = trainNextStation[TrainNumber];
    trainDistanceToNextStation[TrainNumber] = lineDistance[index];
    
}

/*
function to update the time left ti reach the next station -- policy needed
*/
void updateTimeLeft (){
    trainTimeLeft[TrainNumber] -= 1;
}

/*
naive implementation of policy to let a train leave the station
*/
void updateIfTrainCanLeave(){
    if( (trainActualCharge[TrainNumber] &gt;= trainDistanceToNextStation[TrainNumber]) and                            //check the charge
        (trainTimeLeft[TrainNumber] &gt; (trainDistanceToNextStation[TrainNumber] / trainVelocity[TrainNumber])) )    //check the time left
    {
        trainCanLeaveActualStation[TrainNumber] = true;
    }
}

/*
function to update if a train can leave or not the actual station
(value updated to "false" as soon as the train leaves the current station)
*/
void updateCanLeave(bool val){
    trainCanLeaveActualStation[TrainNumber] = val;
}

/*
function used to update all the information for the travel the train is going to run into:
- train current station
- train next station
- train next time (i.e. the max time that can take the following trip)
- train next distance (i.e. the distance to reach the next station)
The order of the updates is crucial!
*/
void updateTravelInfo() {
    trainActualStation[TrainNumber] = trainNextStation[TrainNumber];
    updateNextStation(TrainNumber);
    updateNextTime(TrainNumber);
    updateNextDistance(TrainNumber);
}

/*
check if a train can proceed or must stop since 
- either it is out of power
- or the time is exceeded
*/
bool goOnCheck(){
    return ( (trainTimeLeft[TrainNumber] &gt; 0 ) and (trainActualCharge[TrainNumber] &gt; 0) );
}

/*
update the channel to communicate with the right station
*/
void updateStationChan(int val){
    int stationIndex = trainActualStation[TrainNumber];
    talkingWithStation[stationIndex] += val;
}

void trainWantsToEnter(){
    int stationIndex = trainNextStation[TrainNumber];
    trainWantsToAccess[(stationIndex*3 + TrainNumber)] = 1;
}

bool trainAccessGranted(){
    int stationIndex = trainNextStation[TrainNumber];
    return trainCanAccess[(stationIndex*3 + TrainNumber)];
}
</declaration>
		<location id="id8" x="-935" y="-1028">
			<name x="-969" y="-1054">idle</name>
		</location>
		<location id="id9" x="-1215" y="-833">
			<name x="-1360" y="-825">waiting_in_a_station</name>
		</location>
		<location id="id10" x="-595" y="-833">
			<name x="-595" y="-867">traveling</name>
		</location>
		<location id="id11" x="-1700" y="-833">
			<name x="-1887" y="-816">waiting_outside_a_station</name>
		</location>
		<location id="id12" x="-1215" y="-459">
			<name x="-1249" y="-442">out_of_power</name>
		</location>
		<location id="id13" x="-1215" y="-561">
			<name x="-1257" y="-544">out_of_time</name>
		</location>
		<init ref="id8"/>
		<transition>
			<source ref="id9"/>
			<target ref="id13"/>
			<label kind="guard" x="-1453" y="-782">trainTimeLeft[TrainNumber] == 0</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id13"/>
			<label kind="guard" x="-1139" y="-587">trainTimeLeft[TrainNumber]==0</label>
			<nail x="-722" y="-561"/>
		</transition>
		<transition>
			<source ref="id11"/>
			<target ref="id13"/>
			<label kind="guard" x="-1479" y="-587">trainTimeLeft[TrainNumber]==0</label>
			<nail x="-1547" y="-561"/>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id9"/>
			<label kind="synchronisation" x="-909" y="-1037">initialization?</label>
		</transition>
		<transition>
			<source ref="id11"/>
			<target ref="id11"/>
			<label kind="guard" x="-1955" y="-876">goOnCheck() and
trainIsWaiting[TrainNumber]==true</label>
			<label kind="synchronisation" x="-1955" y="-926">wait?</label>
			<label kind="assignment" x="-1955" y="-910">loose_charge(),
updateTimeLeft()</label>
			<nail x="-1963" y="-833"/>
			<nail x="-1963" y="-935"/>
			<nail x="-1700" y="-935"/>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id10"/>
			<label kind="guard" x="-518" y="-791">trainDistanceToNextStation[TrainNumber] &gt; 0
and goOnCheck()</label>
			<label kind="assignment" x="-518" y="-825">loose_charge(), update_distance(),
updateTimeLeft()</label>
			<nail x="-527" y="-748"/>
			<nail x="-527" y="-833"/>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id9"/>
			<label kind="guard" x="-1615" y="-977">trainCanLeaveActualStation[TrainNumber]==false
and goOnCheck()</label>
			<label kind="assignment" x="-1615" y="-1011">recharge(), updateIfTrainCanLeave(), updateTimeLeft(),
updateStationChan(1)</label>
			<nail x="-1215" y="-1019"/>
			<nail x="-1632" y="-1019"/>
			<nail x="-1632" y="-935"/>
			<nail x="-1232" y="-935"/>
		</transition>
		<transition>
			<source ref="id11"/>
			<target ref="id12"/>
			<label kind="guard" x="-1615" y="-485">trainActualCharge[TrainNumber]==0</label>
			<nail x="-1700" y="-459"/>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id12"/>
			<label kind="guard" x="-1028" y="-485">trainActualCharge[TrainNumber]==0</label>
			<nail x="-595" y="-459"/>
		</transition>
		<transition>
			<source ref="id11"/>
			<target ref="id9"/>
			<label kind="guard" x="-1598" y="-884">goOnCheck() and trainAccessGranted()</label>
			<label kind="synchronisation" x="-1598" y="-901">enter?</label>
			<label kind="assignment" x="-1598" y="-867">updateTravelInfo()</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id11"/>
			<label kind="guard" x="-1122" y="-731">trainDistanceToNextStation[TrainNumber] == 0
and goOnCheck()</label>
			<label kind="assignment" x="-1122" y="-697">trainWantsToEnter()</label>
			<nail x="-765" y="-680"/>
			<nail x="-1513" y="-680"/>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id10"/>
			<label kind="guard" x="-1045" y="-884">trainCanLeaveActualStation[TrainNumber]
and goOnCheck()</label>
			<label kind="synchronisation" x="-1045" y="-901">free_truck!</label>
			<label kind="assignment" x="-1045" y="-850">updateCanLeave(false), updateStationChan(-1)</label>
		</transition>
	</template>
	<system>// Place template instantiations here.
l = Line(0);
s0 = Station(0);
s1 = Station(1);
s2 = Station(2);
t0 = Train(0);
t1 = Train(1);
t2 = Train(2);
sm = StationManager();
// List one or more processes to be composed into a system.
system l, s0, s1, s2, t0, t1, t2, sm;
    </system>
	<queries>
		<query>
			<formula></formula>
			<comment></comment>
		</query>
	</queries>
</nta>
