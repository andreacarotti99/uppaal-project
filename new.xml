<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>// Place global declarations here.
clock general_clock;

chan enter, free_truck, start, wait;


/***********/
urgent broadcast chan initialization;

/***********/

/*
first element is the distance in km from station 1 to station 2, 
second element is the distance in km from station 2 to station 3
EXPRESSED IN UNITS
*/
int lineDistance[2] = {23, 35};

/*
first element is the max time needed to get from station 1 to 2
second element is the max time needed to get from station 2 to 3
EXPRESSED IN CLOCKS
*/
int lineMaxDelay[2] = {20, 30};


/*
this is a sort of map: it provides information of where are currently the trains, the train is the INDEX
so if for example Train(1) is at station 1, Train(2) is at station 3, and Train(3) is at station 2 is initialized like this:
int whereIsTrain[3] = {1, 3, 2};
*/
int trainActualStation[3] = {1,1,1};

/*
same as above, but maps the next station for each train
*/
int trainNextStation[3] = {2,2,2};

/*
this provides info on whether the station INDEX is free or not, 1 means the station is available, 0 means it is not
*/
bool stationAvailableToReceiveTrains[3] = {true,true,true};

/*
number of available trucks free in the INDEX station
*/
int stationNumberOfAvailableTrucks[3] = {0,1,2};

/*
number of total trucks free in the INDEX station
*/
int stationNumberOfTrucks[3] = {3,1,2};

/*
charges of train, first element charge of Train(1), second element charge of Train(2) and third element charge of Train(3)
*/
int trainActualCharge[3] = {100,5,100};

/*
this is the max charge of train INDEX
*/
int trainMaxCharge[3] = {100,100,100};


/*
based on the policy that we will decide, this will be accessed by the Train(i) to check whether can go to the next station, and
will be edited by the station that decides who can leave and who cannot
*/
bool trainCanLeaveActualStation[3] = {false,false,false};


/*
distance in UNITS for train INDEX to reach the next station 
EXPRESSED IN UNITS
*/
int trainDistanceToReachNextStation[3] = {23,23,23};

/*
velocity of Train(i)
EXPRESSED in UNITS/CLOCK
*/
int trainVelocity[3] = {10,10,10};

/*
vector useful to know if a train is going forward or backward: 0-&gt;1-&gt;2
*/
bool trainGoingForward[3] = {true, true, true};

/*
this function is to initialize everything, right now all the parameters are hard-coded 
*/
void initialize_all(){
}

/*
function used to update the next station of each train
*/
void updateNextStation(int trainId) {
    if( trainGoingForward[trainId] ) {
        if(trainActualStation[trainId] &lt; 3 )
            trainNextStation[trainId] += 1;
        else{
            trainGoingForward[trainId] = false; //end of line reached! change direction
            trainNextStation[trainId] -= 1;
        }
    }
    else{
        if(trainActualStation[trainId] &gt; 0)
            trainNextStation[trainId] -= 1;
        else {
            trainGoingForward[trainId] = true;    //first station of line reached! change direction
            trainNextStation[trainId] += 1;
        }
    }
}



</declaration>
	<template>
		<name>Line</name>
		<parameter>int LineNumber</parameter>
		<declaration>// Line Clocks

// Line Variables
typedef struct{
    int distance[2];    //distance (in km) between each pair of consecutive stations
    int max_delay[2];    //maximum time to reach the following station: associated to each pair of consecutive stations
}line;

// Line Functions 
</declaration>
		<location id="id0" x="-391" y="-255">
			<name x="-416" y="-289">working</name>
		</location>
		<location id="id1" x="-604" y="-255">
			<name x="-620" y="-289">initial</name>
			<committed/>
		</location>
		<init ref="id1"/>
		<transition>
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-552" y="-272">initialization!</label>
			<label kind="assignment" x="-544" y="-246">initialize_all()</label>
			<nail x="-425" y="-255"/>
		</transition>
	</template>
	<template>
		<name>Station</name>
		<parameter>int StationNumber</parameter>
		<declaration>// Station Clocks

// Station Variables
typedef struct{
    int trucks;
    int availableTrucks;
}station;

station s;

// Station Functions
void addAvlTrucks(int i) {
   s.availableTrucks += (i);
}

void decideWhoCanLeaveActualStation(){
    trainCanLeaveActualStation[2] = true;
}






</declaration>
		<location id="id2" x="-782" y="-425">
			<name x="-944" y="-442">waiting_for_trains</name>
		</location>
		<location id="id3" x="-348" y="-425">
			<name x="-331" y="-408">fully_occupied</name>
		</location>
		<location id="id4" x="-552" y="-824">
			<name x="-562" y="-858">idle</name>
		</location>
		<init ref="id4"/>
		<transition>
			<source ref="id3"/>
			<target ref="id3"/>
			<label kind="synchronisation" x="-331" y="-391">wait!</label>
			<nail x="-348" y="-306"/>
			<nail x="-110" y="-306"/>
			<nail x="-110" y="-425"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id3"/>
			<label kind="guard" x="-467" y="-688">stationNumberOfAvailableTrucks[StationNumber] == 0</label>
			<label kind="synchronisation" x="-476" y="-714">initialization?</label>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id2"/>
			<label kind="guard" x="-1003" y="-688">stationNumberOfAvailableTrucks[StationNumber] &gt; 0</label>
			<label kind="synchronisation" x="-739" y="-714">initialization?</label>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id2"/>
			<label kind="synchronisation" x="-875" y="-553">enter!</label>
			<label kind="assignment" x="-900" y="-536">addAvlTrucks(-1)</label>
			<nail x="-782" y="-536"/>
			<nail x="-918" y="-536"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id2"/>
			<label kind="guard" x="-909" y="-281">s.availableTrucks&gt;1</label>
			<label kind="synchronisation" x="-867" y="-315">free_truck?</label>
			<label kind="assignment" x="-883" y="-298">addAvlTrucks(1)</label>
			<nail x="-782" y="-298"/>
			<nail x="-901" y="-298"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id2"/>
			<label kind="synchronisation" x="-586" y="-561">free_truck?</label>
			<label kind="assignment" x="-604" y="-577">addAvlTrucks(1)</label>
			<nail x="-552" y="-535"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id3"/>
			<label kind="guard" x="-586" y="-374">s.availableTrucks==1</label>
			<label kind="synchronisation" x="-553" y="-416">enter!</label>
			<label kind="assignment" x="-578" y="-391">addAvlTrucks(-1)</label>
		</transition>
	</template>
	<template>
		<name>Train</name>
		<parameter>int TrainNumber</parameter>
		<declaration>// Train Clocks
clock trainClock;

// Train Functions
void recharge(){
    if( trainActualCharge[TrainNumber] &lt; trainMaxCharge[TrainNumber] + 1 )
        trainActualCharge[TrainNumber] += 1;
}

void loose_charge(){
    if( (trainActualCharge[TrainNumber] - 1) &gt;= 0 )
        trainActualCharge[TrainNumber] -= 1;
}

void update_distance (){
    trainDistanceToReachNextStation[TrainNumber] -= trainVelocity[TrainNumber];
}


//naive
void updateIfTrainCanLeave(){
    if(trainActualCharge[TrainNumber] &gt;= trainDistanceToReachNextStation[TrainNumber]){
        trainCanLeaveActualStation[TrainNumber] = true;
    }
    else {
        trainCanLeaveActualStation[TrainNumber] = false;
    }
}</declaration>
		<location id="id5" x="-1130" y="-790">
			<name x="-1164" y="-816">idle</name>
		</location>
		<location id="id6" x="-1130" y="-646">
			<name x="-1241" y="-680">waiting_in_a_station</name>
		</location>
		<location id="id7" x="-510" y="-646">
			<name x="-535" y="-680">traveling</name>
		</location>
		<location id="id8" x="-1130" y="-331">
			<name x="-1217" y="-314">waiting_outside_a_station</name>
		</location>
		<location id="id9" x="-510" y="-331">
			<name x="-493" y="-340">out_of_power</name>
		</location>
		<init ref="id5"/>
		<transition>
			<source ref="id5"/>
			<target ref="id6"/>
			<label kind="synchronisation" x="-1173" y="-765">initialization?</label>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id8"/>
			<label kind="assignment" x="-1266" y="-450">loose_charge()</label>
			<nail x="-1266" y="-331"/>
			<nail x="-1266" y="-433"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id7"/>
			<label kind="guard" x="-484" y="-739">trainDistanceToReachNextStation[TrainNumber] &gt; 0</label>
			<label kind="assignment" x="-408" y="-714">loose_charge(), update_distance()</label>
			<nail x="-348" y="-646"/>
			<nail x="-348" y="-756"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id6"/>
			<label kind="assignment" x="-1377" y="-629">recharge(), updateIfTrainCanLeave()</label>
			<nail x="-1215" y="-595"/>
			<nail x="-1215" y="-646"/>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id9"/>
			<label kind="guard" x="-952" y="-323">trainActualCharge[TrainNumber]==0</label>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id9"/>
			<label kind="guard" x="-501" y="-510">trainActualCharge[TrainNumber]==0</label>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id6"/>
			<label kind="guard" x="-960" y="-790">trainDistanceToReachNextStation[TrainNumber] == 0</label>
			<label kind="synchronisation" x="-858" y="-815">enter?</label>
			<nail x="-841" y="-790"/>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id6"/>
			<label kind="synchronisation" x="-1122" y="-518">enter?</label>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="guard" x="-994" y="-493">trainDistanceToReachNextStation[TrainNumber] == 0</label>
			<label kind="synchronisation" x="-841" y="-518">wait?</label>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id7"/>
			<label kind="guard" x="-994" y="-637">trainCanLeaveActualStation[TrainNumber]</label>
			<label kind="synchronisation" x="-867" y="-671">free_truck!</label>
		</transition>
	</template>
	<system>// Place template instantiations here.
l = Line(0);
s1 = Station(0);
s2 = Station(1);
s3 = Station(2);
t1 = Train(0);
t2 = Train(1);
t3 = Train(2);
// List one or more processes to be composed into a system.
system l, s1, s2, s3, t1, t2, t3;
    </system>
	<queries>
		<query>
			<formula></formula>
			<comment></comment>
		</query>
	</queries>
</nta>
